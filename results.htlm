<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Patterson — Survey Results</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='6' fill='%231B2A4A'/><text x='50%25' y='55%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-family='Arial' font-weight='bold' font-size='18'>P</text></svg>">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{--navy:#1B2A4A;--blue:#2E6BA6;--light-blue:#D6EBF5;--sky:#EBF5FB;--white:#FFF;--g50:#F9FAFB;--g100:#F3F4F6;--g200:#E5E7EB;--g400:#9CA3AF;--g500:#6B7280;--g700:#374151;--g900:#111827;--red:#EF4444;--orange:#F59E0B;--yellow:#FCD34D;--green:#22C55E;--emerald:#059669}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--g50);color:var(--g900);line-height:1.6;min-height:100vh;-webkit-font-smoothing:antialiased}
    .header{background:linear-gradient(135deg,var(--navy),var(--blue));padding:1.75rem 1.25rem;text-align:center}
    .header h1{color:var(--white);font-size:1.125rem;font-weight:600;letter-spacing:.05em;text-transform:uppercase;margin-bottom:.25rem}
    .header p{color:var(--light-blue);font-size:.875rem}
    .container{max-width:800px;margin:0 auto;padding:1.25rem 1rem 3rem}

    .stat-row{display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-bottom:1.25rem}
    .stat-card{background:var(--white);border-radius:12px;padding:1.25rem;box-shadow:0 1px 3px rgba(0,0,0,.06);border:1px solid var(--g200);text-align:center}
    .stat-card .big{font-size:2.25rem;font-weight:800;color:var(--navy);line-height:1}
    .stat-card .label{font-size:.75rem;color:var(--g500);margin-top:.25rem;text-transform:uppercase;letter-spacing:.04em}

    .section-label{font-size:.6875rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--blue);margin:1.5rem 0 .75rem;padding-left:.125rem}

    .q-result{background:var(--white);border-radius:12px;padding:1.25rem;margin-bottom:.75rem;box-shadow:0 1px 3px rgba(0,0,0,.06);border:1px solid var(--g200)}
    .q-result .q-label{font-size:.8125rem;font-weight:600;color:var(--g700);margin-bottom:.75rem;line-height:1.4}
    .q-result .avg-row{display:flex;align-items:center;gap:.75rem;margin-bottom:.5rem}
    .q-result .avg-num{font-size:1.5rem;font-weight:800;min-width:2.5rem;text-align:center}
    .q-result .avg-bar-wrap{flex:1;height:12px;background:var(--g100);border-radius:6px;overflow:hidden}
    .q-result .avg-bar{height:100%;border-radius:6px;transition:width .6s ease}
    .q-result .avg-out-of{font-size:.75rem;color:var(--g400)}
    .q-result .dist{display:flex;gap:4px;margin-top:.5rem}
    .q-result .dist-bar{flex:1;text-align:center}
    .q-result .dist-fill{height:0;border-radius:4px 4px 0 0;transition:height .6s ease;min-height:2px}
    .q-result .dist-label{font-size:.625rem;color:var(--g400);margin-top:2px}
    .q-result .dist-count{font-size:.625rem;font-weight:600;color:var(--g700);margin-bottom:2px}

    .open-card{background:var(--white);border-radius:12px;padding:1.25rem;margin-bottom:.75rem;box-shadow:0 1px 3px rgba(0,0,0,.06);border:1px solid var(--g200)}
    .open-card .q-label{font-size:.8125rem;font-weight:600;color:var(--g700);margin-bottom:.75rem;line-height:1.4}
    .open-card .response{background:var(--g50);border-left:3px solid var(--blue);padding:.625rem .875rem;margin-bottom:.5rem;border-radius:0 8px 8px 0;font-size:.8125rem;color:var(--g700);line-height:1.5}
    .open-card .response:last-child{margin-bottom:0}
    .open-card .empty{color:var(--g400);font-style:italic;font-size:.8125rem}

    .loading{text-align:center;padding:4rem 2rem;color:var(--g400)}
    .loading .spinner{width:32px;height:32px;border:3px solid var(--g200);border-top-color:var(--blue);border-radius:50%;animation:spin .6s linear infinite;margin:0 auto 1rem}
    @keyframes spin{to{transform:rotate(360deg)}}

    .refresh-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
    .refresh-bar .ts{font-size:.6875rem;color:var(--g400)}
    .refresh-btn{background:var(--sky);border:1px solid var(--light-blue);color:var(--blue);font-size:.75rem;font-weight:600;padding:.375rem .75rem;border-radius:6px;cursor:pointer;-webkit-tap-highlight-color:transparent}
    .refresh-btn:active{transform:scale(.97)}

    .no-data{text-align:center;padding:3rem 2rem}
    .no-data h2{color:var(--g700);font-size:1.25rem;margin-bottom:.5rem}
    .no-data p{color:var(--g400);font-size:.875rem}
  </style>
</head>
<body>
<div class="header">
  <h1>Patterson Dental</h1>
  <p>Field Assessment — Live Results</p>
</div>
<div class="container">
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div>Loading responses...</div>
  </div>
  <div id="content" style="display:none"></div>
</div>

<script>
const SB_URL="https://nikmunvfqtvzzwgiyvem.supabase.co";
const SB_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pa211bnZmcXR2enp3Z2l5dmVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4MzQ5OTUsImV4cCI6MjA4NjQxMDk5NX0.PUzcPaJAZrqLhMb6jepGElLdu4P9OBgga0oVz-d9MDQ";

const questions = [
  {key:"q1_tools_equipped", label:"Patterson has equipped me with all the tools I need to be effective in the field."},
  {key:"q2_training_support", label:"I receive enough training and support to present new products confidently."},
  {key:"q3_admin_time", label:"Admin work does not significantly cut into my selling time."},
  {key:"q4_ai_confidence", label:"I feel confident discussing AI and technology solutions with customers."},
  {key:"q5_competitive_position", label:"Patterson gives its field reps a competitive advantage in tools and resources."},
  {key:"q6_corporate_to_field", label:"Corporate training translates into strategies I can use day-to-day."},
];
const openQs = [
  {key:"q7_tools_wished", label:"What tools or resources would better serve you in the field?"},
  {key:"q8_pain_points", label:"What are your biggest pain points in your day-to-day workflow?"},
  {key:"q9_anything_else", label:"Anything else you'd like leadership to know?"},
];

function getColor(avg) {
  if (avg <= 1.5) return "var(--red)";
  if (avg <= 2.5) return "var(--orange)";
  if (avg <= 3.5) return "var(--yellow)";
  if (avg <= 4.0) return "var(--green)";
  return "var(--emerald)";
}

async function loadData() {
  const res = await fetch(SB_URL + "/rest/v1/survey_responses?select=*&order=submitted_at.desc", {
    headers: {"apikey": SB_KEY, "Authorization": "Bearer " + SB_KEY}
  });
  return await res.json();
}

function render(data) {
  const el = document.getElementById("content");
  document.getElementById("loading").style.display = "none";
  el.style.display = "block";

  if (!data || data.length === 0) {
    el.innerHTML = '<div class="no-data"><h2>No responses yet</h2><p>Results will appear here in real time as reps submit their feedback.</p></div>';
    return;
  }

  const n = data.length;
  const overallAvgs = questions.map(q => {
    const vals = data.map(d => d[q.key]).filter(v => v != null);
    return vals.length ? vals.reduce((a,b) => a+b, 0) / vals.length : 0;
  });
  const grandAvg = overallAvgs.filter(a => a > 0).reduce((a,b) => a+b, 0) / overallAvgs.filter(a => a > 0).length;

  // Find lowest rated question
  let lowestIdx = 0;
  overallAvgs.forEach((a, i) => { if (a > 0 && a < overallAvgs[lowestIdx]) lowestIdx = i; });

  let html = '';

  // Refresh bar
  html += '<div class="refresh-bar">';
  html += '<span class="ts">Updated: ' + new Date().toLocaleTimeString() + '</span>';
  html += '<button class="refresh-btn" onclick="init()">Refresh</button>';
  html += '</div>';

  // Stat cards
  html += '<div class="stat-row">';
  html += '<div class="stat-card"><div class="big">' + n + '</div><div class="label">Responses</div></div>';
  html += '<div class="stat-card"><div class="big" style="color:' + getColor(grandAvg) + '">' + grandAvg.toFixed(1) + '</div><div class="label">Overall Average (out of 5)</div></div>';
  html += '</div>';

  // Scale questions
  html += '<div class="section-label">Rated Questions</div>';

  questions.forEach((q, i) => {
    const vals = data.map(d => d[q.key]).filter(v => v != null);
    const avg = vals.length ? vals.reduce((a,b) => a+b, 0) / vals.length : 0;
    const dist = [0,0,0,0,0];
    vals.forEach(v => dist[v-1]++);
    const maxDist = Math.max(...dist, 1);
    const color = getColor(avg);
    const pct = (avg / 5 * 100).toFixed(0);

    html += '<div class="q-result">';
    html += '<div class="q-label">' + (i+1) + '. ' + q.label + '</div>';
    html += '<div class="avg-row">';
    html += '<div class="avg-num" style="color:' + color + '">' + avg.toFixed(1) + '</div>';
    html += '<div class="avg-bar-wrap"><div class="avg-bar" style="width:' + pct + '%;background:' + color + '"></div></div>';
    html += '<div class="avg-out-of">/ 5</div>';
    html += '</div>';

    // Distribution
    html += '<div class="dist" style="height:60px;align-items:flex-end">';
    const labels = ["1","2","3","4","5"];
    dist.forEach((count, di) => {
      const h = Math.max((count / maxDist) * 40, 2);
      const colors = ["var(--red)","var(--orange)","var(--yellow)","var(--green)","var(--emerald)"];
      html += '<div class="dist-bar">';
      html += '<div class="dist-count">' + (count || '') + '</div>';
      html += '<div class="dist-fill" style="height:' + h + 'px;background:' + colors[di] + '"></div>';
      html += '<div class="dist-label">' + labels[di] + '</div>';
      html += '</div>';
    });
    html += '</div>';
    html += '</div>';
  });

  // Open-ended
  html += '<div class="section-label">Open Feedback</div>';
  openQs.forEach((q, i) => {
    const responses = data.map(d => d[q.key]).filter(v => v && v.trim());
    html += '<div class="open-card">';
    html += '<div class="q-label">' + (7+i) + '. ' + q.label + '</div>';
    if (responses.length === 0) {
      html += '<div class="empty">No responses yet</div>';
    } else {
      responses.forEach(r => {
        html += '<div class="response">' + escHtml(r) + '</div>';
      });
    }
    html += '</div>';
  });

  el.innerHTML = html;
}

function escHtml(s) {
  const d = document.createElement("div");
  d.textContent = s;
  return d.innerHTML;
}

async function init() {
  try {
    const data = await loadData();
    render(data);
  } catch (e) {
    document.getElementById("loading").innerHTML = '<div style="color:#991B1B">Error loading results. Please refresh.</div>';
  }
}

init();
// Auto-refresh every 30 seconds
setInterval(init, 30000);
</script>
</body>
</html>
